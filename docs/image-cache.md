# Кеширование изображений

Этот документ описывает процесс предварительного кеширования изображений через прокси-роут.

## Назначение

Скрипт `cache-images.mjs` предназначен для автоматизации процесса предварительного кеширования всех изображений, находящихся в базе данных. Это улучшает производительность сайта, так как изображения будут загружаться из кеша, а не с Yandex Cloud.

## Как это работает

1. Скрипт извлекает все URL изображений из следующих таблиц базы данных:

   - ProjectMedia
   - BuildingMedia
   - UnitMedia
   - UnitLayout (поля mainImage, planImage, images)
   - Building (поле imageUrl)

2. Скрипт проверяет размер каждого изображения через HEAD-запрос и определяет, требуется ли оптимизация:

   - Для изображений размером меньше 2 МБ - запрос идет без параметров оптимизации
   - Для изображений размером больше 2 МБ - применяется автоматическая оптимизация для обхода ограничений кеша Next.js

3. Для каждого изображения выполняется запрос к прокси-роуту `/api/image-proxy/[...path]`, который:

   - Загружает оригинальное изображение из Yandex Cloud
   - Оптимизирует его (если требуется или указаны параметры)
   - Кеширует результат в Next.js

4. Пути к изображениям конвертируются из формата:

   ```
   https://storage.yandexcloud.net/homio/uploads/image.jpg
   ```

   в формат:

   ```
   http://localhost:3000/api/image-proxy/homio/uploads/image.jpg
   ```

   Для больших изображений добавляются параметры оптимизации:

   ```
   http://localhost:3000/api/image-proxy/homio/uploads/image.jpg?format=webp&quality=80&width=1280&progressive=true
   ```

5. Изображения обрабатываются батчами по 10 штук одновременно, чтобы не перегружать сервер.

## Автоматическая оптимизация больших изображений

Скрипт автоматически оптимизирует большие изображения (более 2 МБ), которые превышают ограничение кеша Next.js. Процесс оптимизации:

1. Для изображений более 2 МБ сначала применяется конвертация в WebP с качеством 80% и уменьшением до 1280px в ширину
2. Если первая попытка оптимизации не удалась, скрипт пробует другие комбинации форматов, качества и размеров:
   - Форматы: WebP, AVIF
   - Уровни качества: 80%, 70%, 60%
   - Ширина: 1920px, 1280px, 800px

Эта функциональность позволяет обойти ограничение Next.js на кеширование объектов размером более 2 МБ.

## Запуск скрипта

### Локально в окружении разработки

```bash
# Из корня проекта
npm run cache:images

# Или через yarn
yarn cache:images
```

### В продакшн-окружении

```bash
NODE_ENV=production npm run cache:images
```

### Параметры

Скрипт использует следующие параметры, которые можно изменить в коде:

- `BATCH_SIZE` - количество одновременных запросов (по умолчанию 10)
- `TIMEOUT` - таймаут на запрос в миллисекундах (по умолчанию 10000)
- `BASE_URL` - базовый URL приложения (по умолчанию `http://localhost:3000` или значение из `NEXT_PUBLIC_BASE_URL`)
- `MAX_CACHE_SIZE` - максимальный размер для кеша Next.js (по умолчанию 2 МБ)
- `OPTIMIZATION_FORMATS` - форматы для оптимизации больших изображений (по умолчанию `["webp", "avif"]`)
- `QUALITY_LEVELS` - уровни качества для оптимизации (по умолчанию `[80, 70, 60]`)
- `WIDTH_OPTIONS` - варианты ширины для оптимизации (по умолчанию `[1920, 1280, 800]`)

## Мониторинг прогресса

Скрипт выводит подробную информацию о процессе кеширования:

- Количество найденных изображений в каждой таблице
- Общее количество уникальных изображений
- Информацию об оптимизированных больших изображениях
- Текущий прогресс (в процентах и абсолютных числах)
- Ошибки и таймауты при загрузке
- Итоговую статистику по завершении, включая количество оптимизированных изображений

## Регулярное выполнение

Рекомендуется настроить регулярное выполнение скрипта через cron для поддержания актуальности кеша:

```bash
# Пример crontab записи для запуска скрипта каждый день в 3:00
0 3 * * * cd /path/to/project && npm run cache:images >> /path/to/logs/cache-images.log 2>&1
```

## Устранение неполадок

### Проблема: Ошибка "Failed to set Next.js data cache, items over 2MB can not be cached"

Эта ошибка возникает, когда Next.js пытается кешировать большие изображения (более 2 МБ). Скрипт автоматически решает эту проблему путем оптимизации таких изображений перед кешированием.

Если ошибка продолжает появляться:

- Убедитесь, что параметр `MAX_CACHE_SIZE` в скрипте установлен правильно (2097152 байт)
- Проверьте, что формат и параметры оптимизации подходят для ваших изображений
- При необходимости уменьшите значения ширины или качества в параметрах `WIDTH_OPTIONS` и `QUALITY_LEVELS`

### Проблема: Скрипт не находит изображения

- Убедитесь, что база данных доступна
- Проверьте корректность строки подключения к базе данных
- Проверьте, что в таблицах действительно есть записи с изображениями

### Проблема: Скрипт находит изображения, но не может их кешировать

- Убедитесь, что приложение Next.js запущено и доступно по указанному BASE_URL
- Проверьте, что прокси-роут `/api/image-proxy/[...path]` работает корректно
- Проверьте доступность Yandex Cloud
